<!DOCTYPE html>
<html lang="en">

<head>
  <title>Macro Meal Plan Builder</title>
  <!--Required meta tags-->
  <meta chaset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!--Bootstrap CSS-->
  <link rel="stylesheet" href="vendor/bootstrap-4.0.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container mt-5">
    <div class="row">
      <h3>Enter Macro Goals Below</h3>
    </div>
    <div class="form">
      <div class="form-group row">
        <div class="col-3">
          <label for="carbs">Carbs (g)</label>
          <input type="number" class="form-control" id="carbs" placeholder="Enter carbs (g)">
        </div>
        <div class="col-3">
          <label for="fat">Fat (g)</label>
          <input type="number" class="form-control" id="fat" placeholder="Enter fat (g)">
        </div>
        <div class="col-3">
          <label for="protein">Protein (g)</label>
          <input type="number" class="form-control" id="protein" placeholder="Enter protein (g)">
        </div>
      </div>
      <div class="row">
        <div class="col-3">
          <p class="lead" id="calculatedCals">Total Calories: </p>
        </div>
      </div>
      <div class="form-group row">
        <div class="col">
          <button id="calculateBtn" type="submit" class="btn btn-primary">Calculate Calories</button>
        </div>
      </div>
    </div>
    <div id="foodSection" class="d-none">
      <hr />
      <div class="row">
        <h3>Select Foods</h3>
      </div>
      <div id="select1" class="selectContainer">
        <div id="foodRow1" class="row pt-3 foodRow">
          <div class="col-2">
            <p>Select/create a food</p>
          </div>
          <div class="col-5">
            <select id="foodSelect1" class="form-control foodSelect">
              <option selected value="">Select a food...</option>
              <option value="Eggs">Eggs</option>
              <option value="Chicken">Chicken Breast</option>
              <option value="Beef">80/20 Ground Beef</option>
              <option value="Cheese">Cheese</option>
              <option value="Rice">White Rice</option>
            </select>
          </div>
          <div class="col-3">
            <button id="create1" type="button" class="btn btn-primary">Create a Food</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row py-3">
      <button id="addFoodBtn" type="button" class="btn btn-outline-secondary btn-sm btn-block">Add Another Food</button>
    </div>
    <div class="row pt-3">
      <button id="servingsBtn" type="button" class="btn btn-success">Calculate Servings</button>
    </div>
    <div id="resultsSection" class="d-none">
      <hr />
      <div class="row">
        <h5>Daily Servings</h5>
      </div>
    </div>
  </div>

  <!-- TODO: Replace CDN references with local copies -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="vendor/bootstrap-4.0.0/dist/js/bootstrap.min.js"></script>
  <script type="module">
    // Enable strict mode
    "use strict";
    import { Food, FoodTotals, DailyGoals, calculateServings } from "./main.js";
    import { getFoodSelect, getResultDisplay, getTotalDisplay, getCustomFoodEditorRow } from "./elements.js";

    let eggs = new Food("Eggs", "egg(s)", 1, 6, 5, 1, 6);
    let chicken = new Food("Chicken", "oz", 0, 9, 1, 1, 24);
    let beef = new Food("Beef", "oz", 0, 7, 5, 1, 24);
    let cheese = new Food("Cheese", "oz", 0, 7, 9, 1, 8);
    let rice = new Food("Rice", "oz", 8, 1, 0, 1, 16);
    let foods = [eggs, chicken, beef, cheese, rice];
    let goals = new DailyGoals();
    onLoad();

    function onLoad() {
      document.getElementById("calculateBtn").addEventListener("click", calculateCals);
      document.getElementById("servingsBtn").addEventListener("click", calcServings);
      document.getElementById("addFoodBtn").addEventListener("click", appendFoodRow);
      document.getElementById("create1").addEventListener("click", () => onCreateFoodClick("1"));
      appendFoodRow();
      appendFoodRow();

      // TODO: Remove, testing
      $("#carbs").val("45");
      $("#fat").val("140");
      $("#protein").val("250");
      calculateCals();
    }

    function onCreateFoodClick(rowIndex) {
      let $selectDiv = $("#select" + rowIndex);
      if ($selectDiv.length > 0) {
        $selectDiv.replaceWith(getCustomFoodEditorRow(rowIndex));
        let doc = document.getElementById("saveFood" + rowIndex);
        document.getElementById("saveFood" + rowIndex).addEventListener("click", () => onSaveFood(rowIndex));
        document.getElementById("clearFood" + rowIndex).addEventListener("click", () => onClearFood(rowIndex));
      }
    }

    function onSaveFood(rowIndex) {
      let name = $("#nameInput" + rowIndex).val();
      let uom = $("#uomInput" + rowIndex).val();
      let carbs = parseInt($("#carbInput" + rowIndex).val());
      let fat = parseInt($("#fatInput" + rowIndex).val());
      let protein = parseInt($("#proteinInput" + rowIndex).val());
      if (!name || !uom || !carbs || !fat || !protein) {
        return;
      }
      foods.push(new Food(name, uom, carbs, fat, protein));
      // TODO: Replace with a new view of added food
    }

    function onClearFood(rowIndex) {
      let $selectDiv = $("#select" + rowIndex);
      if ($selectDiv.length < 1) {
        return;
      }

      $selectDiv.replaceWith(getFoodSelect(rowIndex));
      var newElem = document.getElementById("create" + rowIndex);
      newElem.addEventListener("click", () => onCreateFoodClick(rowIndex));
      //document.getElementById("create" + rowIndex).addEventListener("click", () => onCreateFoodClick(rowIndex));
    }

    function calcServings() {
      // Validate we have some foods selected
      // TODO: Validate we don't have doubles
      let $selects = $("select.foodSelect");
      if ($selects.length < 1) {
        console.log("No foods selected.");
        return;
      }

      // Just filter out duplicates for now
      let dedupd = {};
      let names = $.map($selects, $x => $x.value);
      names.forEach(x => {
        let found = foods.some(y => y.name === x);
        if (found) {
          dedupd[x] = foods.find(y => y.name === x).clone();
        } else {
          // TODO: Handle custom created food in here.
        }
      });
      let input = [];
      for (const prop in dedupd) {
        input.push(dedupd[prop]);
      }
      let results = calculateServings(input, goals);
      console.log(results);
      displayResults(results);
    }

    function displayResults(results) {
      // remove old display
      $(".servingDisplay").remove();
      $(".totalDisplay").remove();
      let $resultSection = $("#resultsSection");
      let $elem = $("<div>", { "class": "servingDisplay" });
      let $totalElem = $("<div>", { "class": "totalDisplay" });

      let display = getResultDisplay(results);
      let totals = new FoodTotals(results);
      let totalDisplay = getTotalDisplay(totals, goals);
      $elem.html(display);
      $totalElem.html(totalDisplay);
      $resultSection.append($elem);
      $resultSection.append($totalElem);

      // Show section
      $resultSection.removeClass("d-none");
    }

    function calculateCals() {
      var carbs = parseInt($("#carbs").val());
      var fat = parseInt($("#fat").val());
      var prot = parseInt($("#protein").val());
      var cals = 4 * carbs + 9 * fat + 4 * prot;
      if (!cals) {
        return;
      }
      goals.carbs = carbs;
      goals.fat = fat;
      goals.protein = prot;
      goals.calories = cals;
      $("#calculatedCals").first().text("Total Calories: " + cals.toString());
      $("#foodSection").removeClass("d-none");
    }

    function appendFoodRow() {
      let $selects = $("select.foodSelect");
      if ($selects.length > 0) {
        let id = $selects.length + 1;
        let $lastSelectDiv = $selects.last().parent().parent().parent();
        let $newSelect = $("<div>", { id: "select" + id });
        let newSelectText = getFoodSelect($selects.length + 1);
        $newSelect.html(newSelectText);
        $lastSelectDiv.after($newSelect);
        document.getElementById("create" + id).addEventListener("click", () => onCreateFoodClick(id));
      } else {
        console.log("Can't find any food selectors! Something's wrong.");
      }
    }
  </script>
</body>

</html>