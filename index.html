<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N5YWZJW0FF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-N5YWZJW0FF');
  </script>

  <!-- Plausible -->
  <script async defer data-domain="macroapp.com" src="https://plausible.io/js/plausible.js"></script>

  <!-- Crisp chat bot -->
  <script
    type="text/javascript">window.$crisp = []; window.CRISP_WEBSITE_ID = "d8568dc2-773d-4a02-9b80-ec8f00e37863"; (function () { d = document; s = d.createElement("script"); s.src = "https://client.crisp.chat/l.js"; s.async = 1; d.getElementsByTagName("head")[0].appendChild(s); })();</script>
  <title>Macro Meal Plan Builder</title>

  <!-- Required meta tags -->
  <meta chaset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="vendor/bootstrap-4.0.0/dist/css/bootstrap.min.css">

  <!-- Montserrat font -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.3/css/bootstrap-select.min.css" />-->
</head>

<body>
  <!-- Uncomment when I actually have other menu items -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
      Macro Mesh
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-sm-2">
        <li class="nav-item">
          <a class="nav-link" href="#" data-toggle="modal" data-target="#requestFeatureModal">Request a Feature</a>
        </li>
      </ul>
    </div>
  </nav>
  <!-- Modal -->
  <div class="modal fade" id="requestFeatureModal" tabindex="-1" role="dialog" aria-labelledby="requestFeatureModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="requestFeatureModalLabel">Requesting a Feature</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>To request a new feature, please use the chat button in the bottom right corner of your screen. This allows you to send a message directly to me, the developer!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="container my-2">
    <div class="row">
      <div class="col">
        <h3>Enter Daily Macro Goals</h3>
      </div>
    </div>
    <div class="form">
      <div class="form-group row">
        <div class="col-lg-3 col-sm-12">
          <label for="carbs">Carbs (g)</label>
          <input type="number" class="form-control" id="carbs" placeholder="Enter carbs (g)">
        </div>
        <div class="col-lg-3 col-sm-12">
          <label for="fat">Fat (g)</label>
          <input type="number" class="form-control" id="fat" placeholder="Enter fat (g)">
        </div>
        <div class="col-lg-3 col-sm-12">
          <label for="protein">Protein (g)</label>
          <input type="number" class="form-control" id="protein" placeholder="Enter protein (g)">
        </div>
      </div>
      <div class="row">
        <div class="col-lg-3 col-sm-12">
          <p class="lead" id="calculatedCals">Total Calories: </p>
        </div>
      </div>
      <div class="form-group row">
        <div class="col">
          <button id="calculateBtn" type="submit" class="btn btn-primary">Calculate Calories</button>
          <i data-toggle="tooltip" data-html="true" data-trigger="hover" data-placement="bottom"
            title="Calculates your calories from your macro goals. <b>If you change your macros after calculating, you must recalculate for the changes to take effect.</b>"
            class="fas fa-lg fa-info-circle text-dark"></i>
        </div>
      </div>
    </div>
    <div id="foodSection" class="d-none row">
      <div class="col">
        <hr />
        <div id="foodSectionHeader" class="row">
          <div class="col">
            <h3>Select Foods
              <i data-toggle="tooltip" data-html="true" data-trigger="hover" data-placement="bottom"
                title="Select the foods you want to eat in a day. Choose from the available options or create your own."
                class="fas fa-xs fa-info-circle text-dark"></i>
            </h3>
          </div>
        </div>
        <div class="row py-3">
          <div class="col">
            <button id="addFoodBtn" type="button" class="btn btn-outline-secondary btn-sm btn-block">Add Another
              Food</button>
          </div>
        </div>
        <div class="row pt-3">
          <div class="col">
            <button id="servingsBtn" type="button" class="btn btn-success">Calculate Servings</button>
          </div>
        </div>
      </div>
    </div>
    <div id="resultsSection" class="d-none row">
      <div class="col">
        <hr />
        <div class="row">
          <div class="col">
            <h5>Daily Servings</h5>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TODO: Replace CDN references with local copies -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="vendor/bootstrap-4.0.0/dist/js/bootstrap.min.js"></script>
  <script src="https://kit.fontawesome.com/8b7fb7a0f0.js" crossorigin="anonymous"></script>
  <!--<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.3/js/bootstrap-select.min.js"></script>-->
  <script type="module">
    // Enable strict mode
    "use strict";
    import { Food, FoodTotals, DailyGoals, calculateServings } from "./main.js";
    import { getFoodSelect, getResultDisplay, getTotalDisplay, getCustomFoodEditorRow, getCreatedFoodRow } from "./elements.js";
    import { getFoods } from "./foods.js";

    let foods = getFoods();
    let goals = new DailyGoals();
    onLoad();

    function onLoad() {
      // This activates all bootstrap tooltips on the page
      $(() => $('[data-toggle="tooltip"]').tooltip());
      // This activates bootstrap picker (for searchable select menus)
      //$(() => $('.selectpicker').selectpicker());
      document.getElementById("calculateBtn").addEventListener("click", calculateCals);
      document.getElementById("servingsBtn").addEventListener("click", calcServings);
      document.getElementById("addFoodBtn").addEventListener("click", appendFoodRow);
      appendFoodRow();
      appendFoodRow();
      appendFoodRow();
      replaceHistory("calculateMacros");

      // TODO: testing, remove
      /**
      $("#carbs").val("45");
      $("#fat").val("140");
      $("#protein").val("250");
      calculateCals();
      */
    }

    function onCreateFoodClick(rowIndex) {
      let $selectDiv = $("#select" + rowIndex);
      if ($selectDiv.length > 0) {
        $selectDiv.replaceWith(getCustomFoodEditorRow(rowIndex));
        let doc = document.getElementById("saveFood" + rowIndex);
        document.getElementById("saveFood" + rowIndex).addEventListener("click", () => onSaveFood(rowIndex));
        document.getElementById("clearFood" + rowIndex).addEventListener("click", () => onClearFood(rowIndex));
      }
    }

    function onRemoveFoodClick(rowIndex) {
      let $selectDiv = $("#select" + rowIndex);
      if ($selectDiv.length > 0) {
        $selectDiv.remove();
      }
    }

    function onSaveFood(rowIndex) {
      let name = $("#nameInput" + rowIndex).val();
      let uom = $("#uomInput" + rowIndex).val();
      let carbs = parseInt($("#carbInput" + rowIndex).val());
      let fat = parseInt($("#fatInput" + rowIndex).val());
      let protein = parseInt($("#proteinInput" + rowIndex).val());
      if (!name || !uom || !carbs || !fat || !protein) {
        return;
      }
      let food = new Food(name, uom, carbs, protein, fat);
      foods.push(food);

      let $selectDiv = $("#select" + rowIndex);
      let createdText = getCreatedFoodRow(rowIndex, food);
      $selectDiv.replaceWith($(createdText));
      let newElem = document.getElementById("remove" + rowIndex).addEventListener("click", () => onRemoveFoodClick(rowIndex));
    }

    function onClearFood(rowIndex) {
      let $selectDiv = $("#select" + rowIndex);
      if ($selectDiv.length < 1) {
        return;
      }

      $selectDiv.replaceWith(getFoodSelect(rowIndex));
      var newElem = document.getElementById("create" + rowIndex);
      newElem.addEventListener("click", () => onCreateFoodClick(rowIndex));
      //document.getElementById("create" + rowIndex).addEventListener("click", () => onCreateFoodClick(rowIndex));
    }

    function calcServings() {
      // Grab the preselected foods
      let $selects = $("select.foodSelect");

      // Grab all custom foods
      let $customs = $("p.customFoodName > strong");

      // Just filter out duplicates for now
      let dedupd = {};
      let names = $.map($selects, $x => $x.value);
      names.push(...$.map($customs, $x => $x.innerText));
      names.forEach(x => {
        let found = foods.some(y => y.name === x);
        if (found) {
          dedupd[x] = foods.find(y => y.name === x).clone();
        } 
      });
      let input = [];
      for (const prop in dedupd) {
        input.push(dedupd[prop]);
      }
      let results = calculateServings(input, goals);
      console.log(results);
      displayResults(results);
      replaceHistory("viewResults");
    }

    function displayResults(results) {
      // remove old display
      $(".servingDisplay").remove();
      $(".totalDisplay").remove();
      let $resultSection = $("#resultsSection > .col");
      let $elem = $("<div>", { "class": "servingDisplay row" });
      let $totalElem = $("<div>", { "class": "totalDisplay row" });

      let display = getResultDisplay(results);
      let totals = new FoodTotals(results);
      let totalDisplay = getTotalDisplay(totals, goals);
      $elem.html(display);
      $totalElem.html(totalDisplay);
      $resultSection.append($elem);
      $resultSection.append($totalElem);

      // Show section
      $resultSection.parent().removeClass("d-none");
    }

    function calculateCals() {
      var carbs = parseInt($("#carbs").val());
      var fat = parseInt($("#fat").val());
      var prot = parseInt($("#protein").val());
      var cals = 4 * carbs + 9 * fat + 4 * prot;
      if (!cals) {
        return;
      }
      goals.carbs = carbs;
      goals.fat = fat;
      goals.protein = prot;
      goals.calories = cals;
      $("#calculatedCals").first().text("Total Calories: " + cals.toString());
      $("#foodSection").removeClass("d-none");
      replaceHistory("selectFoods");
    }

    function replaceHistory(newAction) {
      let path = `#${newAction}`;
      if (window.history.replaceState) {
        window.history.replaceState({}, null, path);
      }
      // Send updated URL
      gtag("config", "G-N5YWZJW0FF", {
        "page_title" : newAction,
        "page_path": path
     });
    }

    function appendFoodRow() {
      let $selects = $("select.foodSelect");
      let id = 0;
      let $newSelect = null;
      if ($selects.length > 0) {
        // Append a row
        id = $selects.length + 1;
        let $lastSelectDiv = $selects.last().parent().parent().parent();
        let newSelectText = getFoodSelect(id);
        $newSelect = $(newSelectText);
        $lastSelectDiv.after($newSelect);
      } else {
        // Handle the case of no rows existing yet
        id = 1;
        let newSelectText = getFoodSelect(id);
        $newSelect = $(newSelectText);
        let $foodSectionHeader = $("#foodSectionHeader");
        if ($foodSectionHeader.length > 0) {
          $foodSectionHeader.after($newSelect);
        }
      }
      $newSelect = $(`#foodSelect${id}`);
      $newSelect.append($("<option>", { value: "" }).text("Select a food..."));
      foods.forEach(x => {
          $newSelect.append($("<option>", { value: x.name }).text(x.name));
      });
      // Add event handlers
      document.getElementById("create" + id).addEventListener("click", () => onCreateFoodClick(id));
      document.getElementById("remove" + id).addEventListener("click", () => onRemoveFoodClick(id));
    }
  </script>
</body>

</html>